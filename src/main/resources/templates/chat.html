<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Chat</title>
    <style>
        body{font-family:Arial, sans-serif;margin:0;height:100vh;display:flex;flex-direction:column}
        header{padding:12px 16px;border-bottom:1px solid #eee}
        main{flex:1;display:flex;flex-direction:column}
        .messages{flex:1;overflow:auto;padding:16px;background:#fafafa}
        .msg{margin:8px 0;padding:10px 12px;border-radius:8px;max-width:70%;display:inline-block}
        .user{background:#e6f7ff;border:1px solid #91d5ff}
        .agent{background:#fffbe6;border:1px solid #ffe58f}
        .staff{background:#f6ffed;border:1px solid #b7eb8f}
        .left{align-self:flex-start;text-align:left}
        .right{align-self:flex-end;text-align:left}
        .row{display:flex}
        .row.left{justify-content:flex-start}
        .row.right{justify-content:flex-end}
        .meta{font-size:12px;color:#888;margin-bottom:6px}
        form{display:flex;gap:8px;padding:12px;border-top:1px solid #eee;position:sticky;bottom:0;background:#fff}
        textarea{flex:1;padding:8px}
    </style>
    </head>
<body>
<header>
    <a th:href="@{/}">◀ Back</a>
</header>
<main>
    <div id="messages" class="messages">
        <div th:each="m,stat: ${messages}"
             th:with="mine=${m.senderType == 'user' and m.senderUserId == currentUserId}"
             th:class="${'row ' + (mine ? 'right' : 'left')}">
            <div th:class="${'msg ' + (m.senderType) + ' ' + (mine ? 'right' : 'left')}"
                 th:id="${stat.last} ? 'last' : null">
                <div class="meta" th:text="${m.roleKey} + ' • ' + ${m.senderType}"></div>
                <div th:utext="${m.content}"></div>
            </div>
        </div>
    </div>
    <form th:action="@{'/chat/' + ${conversationId} + '/send'}" method="post">
        <textarea name="content" rows="2" placeholder="Type a message..." required></textarea>
        <button type="submit">Send</button>
    </form>
</main>
<script>
  (function(){
    function scrollToLatest(){
      var last = document.getElementById('last');
      if (last && last.scrollIntoView) {
        last.scrollIntoView({block:'end'});
        return;
      }
      var box = document.getElementById('messages');
      if (box) { box.scrollTop = box.scrollHeight; }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', scrollToLatest);
    } else {
      scrollToLatest();
    }
  })();
</script>
</body>
</html>


