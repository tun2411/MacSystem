<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Chat</title>
    <style>
        body{font-family:Arial, sans-serif;margin:0;height:100vh;display:flex;flex-direction:column;color:#1f2937;
            background:
              radial-gradient(1200px 600px at -10% -10%, #e0f2fe 0%, rgba(224,242,254,0) 70%),
              radial-gradient(1000px 500px at 110% 0%, #fee2e2 0%, rgba(254,226,226,0) 65%),
              radial-gradient(900px 500px at 50% 120%, #e9d5ff 0%, rgba(233,213,255,0) 60%),
              linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%)}
        .container{width:100%;max-width:980px;margin:0 auto;box-sizing:border-box;padding:0 16px}
        header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.85);backdrop-filter:saturate(180%) blur(8px);-webkit-backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid #e5e7eb}
        .toolbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
        .toolbar-left{display:flex;align-items:center;gap:10px}
        .back-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid #e5e7eb;background:#fff;border-radius:999px;color:#111827;text-decoration:none;font-weight:600}
        .back-btn:hover{background:#f9fafb}
        .staff-badge{display:inline-flex;align-items:center;gap:6px;background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
        .toolbar-actions a{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:#111827;color:#fff;border-radius:10px;text-decoration:none;border:1px solid #111827}
        .toolbar-actions a:hover{background:#1f2937}
        .floating-back{position:fixed;left:16px;top:16px;z-index:50;display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border:1px solid #e5e7eb;background:#fff;border-radius:999px;color:#111827;text-decoration:none;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .floating-back:hover{background:#f9fafb}
        main{flex:1;display:flex;flex-direction:column}
        .container-full{flex:1;display:flex}
        .messages{flex:1;overflow:auto;padding:20px 16px 24px;background:rgba(255,255,255,.55);border:1px solid #e5e7eb;border-radius:16px;backdrop-filter:saturate(140%) blur(6px);-webkit-backdrop-filter:saturate(140%) blur(6px)}
        .thread{display:flex;flex-direction:column;gap:10px}
        .row{display:flex;align-items:flex-end;gap:8px}
        .row.left{justify-content:flex-start}
        .row.right{justify-content:flex-end}
        .msg{margin:2px 0;padding:10px 12px;border-radius:16px;max-width:72%;display:inline-block;box-shadow:0 1px 1px rgba(0,0,0,.02),0 2px 4px rgba(0,0,0,.04)}
        .row.left .msg{border-top-left-radius:8px;border-top-right-radius:16px;border-bottom-right-radius:16px;border-bottom-left-radius:4px}
        .row.right .msg{border-top-left-radius:16px;border-top-right-radius:8px;border-bottom-right-radius:4px;border-bottom-left-radius:16px}
        .meta{font-size:12px;color:#6b7280;margin-bottom:6px;display:flex;gap:8px;align-items:center}
        .edited{font-style:italic;color:#9ca3af}
        .time{font-variant-numeric:tabular-nums;color:#9ca3af}
        .msg .content{font-size:14px;line-height:1.45;white-space:pre-wrap}
        .user{background:#e8f3ff;border:1px solid #cde3ff}
        .agent{background:#fff8e7;border:1px solid #ffe2a8}
        .staff{background:#ecfdf5;border:1px solid #bbf7d0}
        .staff.right,.agent.right{background:#e8f3ff;border:1px solid #cde3ff}
        form{display:flex;padding:14px 16px;position:sticky;bottom:0;background:rgba(255,255,255,.0);backdrop-filter:saturate(140%) blur(6px)}
        .composer{display:flex;gap:10px;align-items:center;width:100%;border:1px solid #eef2f7;border-radius:14px;background:#ffffff;box-shadow:0 1px 2px rgba(0,0,0,.03);padding:6px 8px}
        .composer:focus-within{border-color:#c7d2fe;box-shadow:0 0 0 3px rgba(99,102,241,.12)}
        textarea{flex:1;padding:10px 12px;border:none;border-radius:10px;resize:none;font-size:14px;outline:none;background:transparent;max-height:160px;min-height:42px}
        textarea:focus{outline:none}
        #sendButton{height:40px;padding:0 16px;background:#2563eb;color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:700;white-space:nowrap}
        #sendButton:hover{background:#1d4ed8}
        .secondary-btn{padding:10px 12px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:12px;cursor:pointer}
        .secondary-btn:hover{background:#e5e7eb}
    </style>
    <!-- Realtime libs -->
    <script src="https://unpkg.com/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://unpkg.com/stompjs@2.3.3/lib/stomp.min.js"></script>
    </head>
<body>
<a class="floating-back" th:href="@{/conversations}">‚üµ Back</a>
<header>
    <div class="container toolbar">
        <div class="toolbar-left">
            <a class="back-btn" th:href="@{/conversations}">‚üµ Back</a>
            <span class="staff-badge" th:if="${session.isStaff}">üë®‚Äçüíº Staff</span>
        </div>
        <div class="toolbar-actions" th:if="${session.isStaff}">
            <a th:href="@{'/chat/' + ${conversationId} + '/agents'}">Manage participants</a>
        </div>
    </div>
    </header>
<main>
    <div class="container container-full">
    <div id="messages" class="messages" th:attr="data-conversation-id=${conversationId},data-current-user-id=${currentUserId},data-is-staff=${isStaff}">
        <div class="thread">
        <!-- Error message display -->
        <div th:if="${param.error}" class="error-message" style="background: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 8px; margin: 8px 0; border-radius: 4px;">
            <span th:if="${param.error[0] == 'empty_message'}">Please enter a message before sending.</span>
        </div>
        
        <div th:each="m,stat: ${messages}"
             th:with="isStaff=${session.isStaff != null and session.isStaff}, 
                      isCurrentUser=${m.senderType == 'user' and m.senderUserId == currentUserId},
                      canEdit=${(m.senderType == 'user' and m.senderUserId == currentUserId) or (isStaff and m.senderType == 'staff' and m.senderUserId == currentUserId)},
                      shouldShowRight=${isStaff and (m.senderType == 'agent' or m.senderType == 'staff') or (!isStaff and isCurrentUser)}"
             th:class="${'row ' + (shouldShowRight ? 'right' : 'left')}">
            <div th:class="${'msg ' + (m.senderType) + ' ' + (shouldShowRight ? 'right' : 'left')}"
                 th:id="${stat.last} ? 'last' : null"
                 th:attr="data-id=${m.id},data-role=${m.roleKey},data-sender-type=${m.senderType},data-sender-user-id=${m.senderUserId},data-editable=${canEdit}">
                <div class="meta">
                    <span th:text="${m.roleKey} + ' ‚Ä¢ ' + ${m.senderType}"></span>
                    <span class="time" th:text="${#temporals.format(m.createdAt, 'HH:mm')} "></span>
                    <span class="edited" th:if="${m.editedAt != null}">(edited)</span>
                </div>
                <div class="content" th:utext="${m.content}"></div>
            </div>
        </div>
        </div>
    </div>
    </div>
    <form class="container" th:action="@{'/chat/' + ${conversationId} + '/send'}" method="post" id="messageForm">
        <div class="composer">
            <textarea name="content" rows="2" placeholder="Type a message..." id="messageInput" required></textarea>
            <button type="submit" id="sendButton">Send</button>
        </div>
    </form>
</main>
<script>
  // Global function for form validation - simplified
  function validateAndSubmit(form) {
    var messageInput = form.querySelector('textarea[name="content"]');
    console.log('validateAndSubmit called');
    
    if (!messageInput) {
      console.log('Message input not found in form');
      return false;
    }
    
    var messageValue = messageInput.value;
    console.log('Message value:', JSON.stringify(messageValue));
    console.log('Message length:', messageValue ? messageValue.length : 0);
    
    // Only check if completely empty (no spaces or content)
    if (!messageValue || messageValue.length === 0) {
      console.log('Message is completely empty');
      alert('Please enter a message before sending.');
      return false;
    }
    
    console.log('Validation passed, allowing submit');
    return true;
  }
  
  // Removed debug and test-input helpers

  (function(){
    function scrollToLatest(){
      var last = document.getElementById('last');
      if (last && last.scrollIntoView) {
        last.scrollIntoView({block:'end'});
        return;
      }
      var box = document.getElementById('messages');
      if (box) { box.scrollTop = box.scrollHeight; }
    }
    
    function renderIncomingMessage(msg){
      try{
        var box = document.getElementById('messages');
        if(!box) return;
        var isStaff = (box.getAttribute('data-is-staff') === 'true' || box.getAttribute('data-is-staff') === 'True');
        var currentUserId = box.getAttribute('data-current-user-id');
        var shouldShowRight = false;
        if (isStaff) {
          shouldShowRight = (msg.senderType === 'agent' || msg.senderType === 'staff');
        } else {
          shouldShowRight = (msg.senderType === 'user' && msg.senderUserId === currentUserId);
        }
        var row = document.createElement('div');
        row.className = 'row ' + (shouldShowRight ? 'right' : 'left');
        var bubble = document.createElement('div');
        bubble.className = 'msg ' + msg.senderType + ' ' + (shouldShowRight ? 'right' : 'left');
        bubble.setAttribute('data-id', msg.id || '');
        bubble.setAttribute('data-role', msg.roleKey || '');
        bubble.setAttribute('data-sender-type', msg.senderType || '');
        bubble.setAttribute('data-sender-user-id', msg.senderUserId || '');
        var isStaff = (box.getAttribute('data-is-staff') === 'true' || box.getAttribute('data-is-staff') === 'True');
        var currentUserId = box.getAttribute('data-current-user-id');
        var canEdit = (msg.senderType === 'user' && msg.senderUserId === currentUserId) ||
                      (isStaff && (msg.senderType === 'staff' && msg.senderUserId === currentUserId));
        bubble.setAttribute('data-editable', canEdit);
        var meta = document.createElement('div');
        meta.className = 'meta';
        var metaText = document.createElement('span');
        metaText.textContent = (msg.roleKey || '') + ' ‚Ä¢ ' + (msg.senderType || '');
        var timeSpan = document.createElement('span');
        timeSpan.className = 'time';
        if (msg.createdAt) {
          try { timeSpan.textContent = new Date(msg.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); } catch(_) {}
        }
        var editedSpan = document.createElement('span');
        if (msg.editedAt) { editedSpan.className = 'edited'; editedSpan.textContent = '(edited)'; }
        meta.appendChild(metaText);
        meta.appendChild(timeSpan);
        if (msg.editedAt) meta.appendChild(editedSpan);
        var content = document.createElement('div');
        content.innerHTML = msg.content || '';
        bubble.appendChild(meta);
        bubble.appendChild(content);
        row.appendChild(bubble);
        box.appendChild(row);
        scrollToLatest();
      } catch(e){
        console.error('Failed to render incoming message', e);
      }
    }
    
    function connectRealtime(){
      var box = document.getElementById('messages');
      if(!box) return;
      var conversationId = box.getAttribute('data-conversation-id');
      if(!conversationId) return;
      try{
        var socket = new SockJS('/ws');
        var stomp = Stomp.over(socket);
        // Optional: silence debug logs
        stomp.debug = null;
        stomp.connect({}, function(){
          stomp.subscribe('/topic/conversations/' + conversationId, function(frame){
            try{
              var payload = JSON.parse(frame.body);
              renderIncomingMessage(payload);
            } catch(e){
              console.error('Bad message payload', e, frame.body);
            }
          });
        }, function(error){
          console.error('STOMP connection error', error);
        });
      } catch(e){
        console.error('Failed to init realtime', e);
      }
    }
    
    function showLoadingState() {
      var sendButton = document.getElementById('sendButton');
      var messageInput = document.getElementById('messageInput');
      if (sendButton) {
        sendButton.disabled = true;
        sendButton.textContent = 'Sending...';
      }
      if (messageInput) {
        messageInput.disabled = true;
      }
    }
    
    function hideLoadingState() {
      var sendButton = document.getElementById('sendButton');
      var messageInput = document.getElementById('messageInput');
      if (sendButton) {
        sendButton.disabled = false;
        sendButton.textContent = 'Send';
      }
      if (messageInput) {
        messageInput.disabled = false;
        messageInput.value = '';
        messageInput.focus();
      }
    }
    
    // Handle form submission with fetch to avoid reload
    var messageForm = document.getElementById('messageForm');
    if (messageForm) {
      messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var messageInput = document.getElementById('messageInput');
        var value = messageInput ? messageInput.value : '';
        if (!value || value.length === 0) {
          alert('Please enter a message before sending.');
          return;
        }
        showLoadingState();
        var url = messageForm.getAttribute('action');
        fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'content=' + encodeURIComponent(value),
          redirect: 'manual'
        }).then(function(){
          hideLoadingState();
        }).catch(function(err){
          console.error('Send failed', err);
          hideLoadingState();
        });
      });
    }
    
    // Auto-hide error messages
    function hideErrorMessages() {
      var errorMessages = document.querySelectorAll('.error-message');
      errorMessages.forEach(function(errorMsg) {
        setTimeout(function() {
          errorMsg.style.opacity = '0';
          setTimeout(function() {
            errorMsg.remove();
          }, 300);
        }, 3000); // Hide after 3 seconds
      });
    }
    
    function enableInlineEditing() {
      var box = document.getElementById('messages');
      if (!box) return;
      box.addEventListener('click', function(e) {
        var bubble = e.target.closest('.msg');
        if (!bubble) return;
        var editable = bubble.getAttribute('data-editable');
        if (editable !== 'true' && editable !== 'True') return;
        // Avoid duplicate editor
        if (bubble.querySelector('.edit-actions')) return;
        var contentEl = bubble.querySelector('.content');
        if (!contentEl) return;
        var originalHtml = contentEl.innerHTML;
        var originalText = contentEl.textContent;
        var textarea = document.createElement('textarea');
        textarea.value = originalText;
        textarea.style.width = '100%';
        textarea.style.boxSizing = 'border-box';
        textarea.style.fontSize = '14px';
        textarea.style.lineHeight = '1.45';
        contentEl.replaceWith(textarea);
        var actions = document.createElement('div');
        actions.className = 'edit-actions';
        actions.style.marginTop = '8px';
        var saveBtn = document.createElement('button');
        saveBtn.textContent = 'Save';
        saveBtn.className = 'secondary-btn';
        var cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.className = 'secondary-btn';
        actions.appendChild(saveBtn);
        actions.appendChild(cancelBtn);
        bubble.appendChild(actions);

        function restore() {
          var newContent = document.createElement('div');
          newContent.className = 'content';
          newContent.innerHTML = originalHtml;
          textarea.replaceWith(newContent);
          actions.remove();
        }

        cancelBtn.addEventListener('click', function(ev){ ev.preventDefault(); restore(); });

        saveBtn.addEventListener('click', function(ev){
          ev.preventDefault();
          var newVal = textarea.value.trim();
          if (newVal.length === 0) { alert('N·ªôi dung kh√¥ng ƒë∆∞·ª£c tr·ªëng'); return; }
          var messageId = bubble.getAttribute('data-id');
          var roleKey = bubble.getAttribute('data-role') || '';
          fetch('/api/messages/' + encodeURIComponent(messageId), {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roleKey: roleKey, newContent: newVal })
          }).then(function(res){
            if (!res.ok) throw new Error('Failed to save');
            return res.json();
          }).then(function(updated){
            // Update UI with new content and edited flag
            var newContent = document.createElement('div');
            newContent.className = 'content';
            newContent.textContent = updated.content || newVal;
            textarea.replaceWith(newContent);
            var meta = bubble.querySelector('.meta');
            if (meta && !meta.querySelector('.edited')) {
              var edited = document.createElement('span');
              edited.className = 'edited';
              edited.textContent = '(edited)';
              meta.appendChild(edited);
            }
            actions.remove();
          }).catch(function(err){
            alert('L∆∞u th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i');
            console.error(err);
          });
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        scrollToLatest();
        hideLoadingState();
        hideErrorMessages();
        connectRealtime();
        enableInlineEditing();
      });
    } else {
      scrollToLatest();
      hideLoadingState();
      hideErrorMessages();
      connectRealtime();
      enableInlineEditing();
    }
  })();
</script>
</body>
</html>


